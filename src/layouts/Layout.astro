---
import { ClientRouter } from 'astro:transitions';
import Header from '@/components/Header.astro';
import Footer from '@/components/Footer.astro';
import { getBrandConfig } from '@/utils/api/brandConfig';
import { freshInstallStore } from '@/stores/backend';
import type { MenuNode } from '@/types/tractstack';
import type { ImpressionNode } from '@/types/compositorTypes';
export interface Props {
  title: string;
  slug?: string;
  menu?: MenuNode | null;
  created?: string;
  canonicalURL?: string;
  pubDatetime?: Date;
  modDatetime?: Date | null;
  ogImage?: string;
  isContext?: boolean;
  isStoryKeep?: boolean;
  isEditor?: boolean;
  isEditable?: boolean;
  brandConfig?: any;
  storyfragmentId?: string;
  sessionId?: string;
  impressions?: ImpressionNode[];
}

const {
  title,
  description = '',
  slug = '',
  menu = null,
  created,
  canonicalURL = Astro.url.pathname,
  pubDatetime,
  modDatetime,
  ogImage,
  isContext = false,
  isStoryKeep = false,
  isEditor = false,
  isEditable = false,
  brandConfig: propBrandConfig,
  storyfragmentId = '',
  sessionId = '',
  impressions = [],
} = Astro.props;

const isDev = import.meta.env.DEV;

// Get site status from the store
const isInitialized = !freshInstallStore.get().needsSetup;

// ensure we have brand config!
const goBackend = import.meta.env.PUBLIC_GO_BACKEND || 'http://localhost:8080';
const tenantId =
  Astro.locals.tenant?.id || import.meta.env.PUBLIC_TENANTID || 'default';
const brandConfig = propBrandConfig || (await getBrandConfig(tenantId));

// Conditionally set asset paths based on initialization status
const cssBasePath = isInitialized ? '/media/css' : '/styles';
const fontBasePath = isInitialized ? '/media/fonts' : '/fonts';
const mainStylesUrl = (() => {
  const baseUrl =
    isStoryKeep || isDev
      ? `${cssBasePath}/storykeep.css`
      : `${cssBasePath}/frontend.css`;

  // Only add version for frontend.css (the dynamic one)
  if (!isStoryKeep && !isDev && brandConfig?.STYLES_VER) {
    return `${baseUrl}?v=${brandConfig.STYLES_VER}`;
  }

  return baseUrl;
})();

// Social media and SEO setup
const defaultFavIcon = brandConfig.FAVICON || `/brand/favicon.ico`;
const defaultSocialImageURL = ogImage || brandConfig.OG || `/brand/og.png`;
const defaultSocialLogoURL = brandConfig.OGLOGO || `/brand/oglogo.png`;
const defaultSocialTitle =
  typeof title === `string` && title
    ? title
    : typeof brandConfig.OGTITLE === `string`
      ? brandConfig.OGTITLE
      : `TractStack dynamic website`;
const defaultSocialAuthor = brandConfig.OGAUTHOR || `TractStack`;
const defaultSocialDesc =
  description ||
  brandConfig.OGDESC ||
  `No-code website builder and content marketing platform`;
const buildVersion = (() => {
  if (modDatetime) return modDatetime.getTime();
  if (pubDatetime) return pubDatetime.getTime();
  return Date.now();
})();
const socialImageWithVersion = `${defaultSocialImageURL}?v=${buildVersion}`;
const socialLogoWithVersion = `${defaultSocialLogoURL}?v=${buildVersion}`;
const gtagId = brandConfig?.GTAG || false;
const gtagUrl =
  typeof gtagId === `string` && gtagId.length > 1
    ? `https://www.googletagmanager.com/gtag/js?id=${gtagId}`
    : null;
const fullCanonicalUrl = brandConfig?.SITE_URL
  ? canonicalURL.startsWith('/')
    ? `${brandConfig.SITE_URL.replace(/\/$/, '')}${canonicalURL}`
    : `${brandConfig.SITE_URL.replace(/\/$/, '')}/${canonicalURL}`
  : canonicalURL;

const enableBunny = import.meta.env.PUBLIC_ENABLE_BUNNY === 'true';
---

<!doctype html>
<html lang="en" class="motion-safe:scroll-smooth">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, viewport-fit=cover"
    />
    <meta name="description" content={defaultSocialDesc} />
    <meta name="author" content={defaultSocialAuthor} />
    <meta name="generator" content={Astro.generator} />
    <link rel="icon" type="image/svg+xml" href={defaultFavIcon} />
    <link rel="canonical" href={fullCanonicalUrl} />
    <title>{defaultSocialTitle}</title>
    <link rel="stylesheet" href={`${cssBasePath}/custom.css`} />
    <link rel="stylesheet" href={mainStylesUrl} />
    <link rel="sitemap" href="/sitemap.xml" />

    <meta name="storyfragment-id" content={storyfragmentId} />
    <meta name="session-id" content={sessionId} />

    <meta name="title" content={defaultSocialTitle} />
    <meta
      property="og:site_name"
      content={brandConfig?.OGAUTHOR || brandConfig?.OGTITLE || 'TractStack'}
    />
    <meta property="og:image:width" content="1200" />
    <meta property="og:image:height" content="630" />
    <meta
      property="og:image:alt"
      content={`${defaultSocialTitle} - Social Preview Image`}
    />
    <meta property="og:locale" content="en_US" />

    <meta property="og:title" content={defaultSocialTitle} />
    <meta property="og:type" content="website" />
    <meta property="og:description" content={defaultSocialDesc} />
    <meta property="og:url" content={fullCanonicalUrl} />
    <meta property="og:image" content={socialImageWithVersion} />
    <meta property="og:logo" content={socialLogoWithVersion} />

    <meta property="twitter:card" content="summary_large_image" />
    <meta property="twitter:url" content={fullCanonicalUrl} />
    <meta property="twitter:title" content={defaultSocialTitle} />
    <meta property="twitter:description" content={defaultSocialDesc} />
    <meta property="twitter:image" content={socialImageWithVersion} />

    {
      pubDatetime && (
        <meta
          property="article:published_time"
          content={pubDatetime.toISOString()}
        />
      )
    }
    {
      modDatetime && (
        <meta
          property="article:modified_time"
          content={modDatetime.toISOString()}
        />
      )
    }

    {gtagUrl && <script async src={gtagUrl} is:inline />}
    <script is:inline define:vars={{ gtagId: brandConfig?.GTAG || '' }}>
      (function () {
        if (gtagId && gtagId.length > 1) {
          window.dataLayer = window.dataLayer || [];
          window.gtag =
            window.gtag ||
            function () {
              window.dataLayer.push(arguments);
            };

          window.gtag('js', new Date());
          window.gtag('config', gtagId);

          document.addEventListener('astro:after-swap', () => {
            window.gtag('config', gtagId);
          });
        }
      })();
    </script>

    <ClientRouter />

    {
      enableBunny && (
        <script
          is:inline
          type="text/javascript"
          src="//assets.mediadelivery.net/playerjs/player-0.1.0.min.js"
        />
      )
    }

    <script src="/client/htmx.min.js" is:inline is:persist></script>

    <script
      define:vars={{
        goBackend,
        tenantId,
        fontBasePath,
        storyfragmentId,
        sessionId,
      }}
      is:inline
    >
      function createTractstackConfig() {
        window.TRACTSTACK_CONFIG = {
          configured: true,
          backendUrl: goBackend,
          tenantId: tenantId,
          fontBasePath: fontBasePath,
          storyfragmentId: storyfragmentId,
          sessionId: sessionId,
        };
      }

      function updateTractstackConfig() {
        // Get current values from meta tags
        const storyfragmentMeta = document.querySelector(
          'meta[name="storyfragment-id"]'
        );
        const sessionMeta = document.querySelector('meta[name="session-id"]');

        const currentStoryfragmentId = storyfragmentMeta
          ? storyfragmentMeta.content
          : null;
        const currentSessionId = sessionMeta ? sessionMeta.content : sessionId;
        if (window.TRACTSTACK_CONFIG && currentStoryfragmentId) {
          window.TRACTSTACK_CONFIG.storyfragmentId = currentStoryfragmentId;
          window.TRACTSTACK_CONFIG.sessionId = currentSessionId;
        } else {
          createTractstackConfig();
        }
      }

      // Check if config exists.
      // If not, create it. This handles the very first load.
      if (!window.TRACTSTACK_CONFIG) {
        createTractstackConfig();
      }

      // Update on subsequent loads, or set for the first time if script runs after initial setup
      document.addEventListener('astro:page-load', updateTractstackConfig);
    </script>
  </head>
  <body class="w-full font-main">
    {
      !isEditor && (
        <Header
          title={title}
          slug={slug}
          brandConfig={brandConfig}
          isContext={isContext}
          isStoryKeep={isStoryKeep}
          isEditable={isEditable}
          sessionId={sessionId}
          menu={menu}
          storyfragmentId={storyfragmentId}
          impressions={impressions}
        />
      )
    }
    <div
      id="loading-indicator"
      class="fixed left-0 top-0 z-50 h-1 w-full scale-x-0 transform bg-myorange transition-transform duration-300 ease-out"
      style="opacity: 0.5; filter: blur(0.5px);"
    >
    </div>

    <div id="content" class="transition-opacity duration-300">
      <slot />
    </div>
    {
      !isEditor && (
        <Footer
          slug={slug}
          brandConfig={brandConfig}
          isContext={isContext}
          menu={menu}
          created={created}
          backToTop={true}
        />
      )
    }
    <script type="module" is:inline is:persist is:raw>
      import '/client/sse.js';
      import '/client/belief-events.js';
      import '/client/analytics-events.js';
    </script>

    <script is:inline is:persist>
      // Navigation loading animation - exact copy of helpers.ts implementation
      let navProgressInterval = null;
      let navSafetyTimeout = null;

      function startNavLoadingAnimation() {
        const loadingIndicator = document.getElementById('loading-indicator');

        if (
          window.matchMedia('(prefers-reduced-motion: no-preference)')
            .matches &&
          loadingIndicator
        ) {
          // Clear any existing safety timeout
          if (navSafetyTimeout !== null) {
            clearTimeout(navSafetyTimeout);
            navSafetyTimeout = null;
          }

          loadingIndicator.style.transform = 'scaleX(0)';
          loadingIndicator.style.display = 'block';

          let progress = 0;
          navProgressInterval = setInterval(() => {
            progress += 2;
            if (progress > 90) {
              if (navProgressInterval !== null) {
                clearInterval(navProgressInterval);
              }
              return;
            }
            loadingIndicator.style.transform = `scaleX(${progress / 100})`;
          }, 20);

          // AUTOMATIC SHUTOFF: Always stop after 10 seconds
          navSafetyTimeout = setTimeout(() => {
            stopNavLoadingAnimation();
          }, 10000);
        }
      }

      function stopNavLoadingAnimation() {
        const loadingIndicator = document.getElementById('loading-indicator');
        const content = document.getElementById('content');

        // Clear safety timeout
        if (navSafetyTimeout !== null) {
          clearTimeout(navSafetyTimeout);
          navSafetyTimeout = null;
        }

        if (
          window.matchMedia('(prefers-reduced-motion: no-preference)')
            .matches &&
          loadingIndicator
        ) {
          if (navProgressInterval !== null) {
            clearInterval(navProgressInterval);
            navProgressInterval = null;
          }
          loadingIndicator.style.transform = 'scaleX(1)';
          content.style.opacity = '1';

          setTimeout(() => {
            loadingIndicator.style.display = 'none';
            loadingIndicator.style.transform = 'scaleX(0)';
          }, 300);
        }
      }

      // Set up navigation loading
      function setupNavigationLoading() {
        document.addEventListener('astro:before-preparation', () => {
          startNavLoadingAnimation();
        });

        document.addEventListener('astro:page-load', () => {
          stopNavLoadingAnimation();
        });

        document.addEventListener('astro:after-swap', () => {
          stopNavLoadingAnimation();
        });
      }

      // Initialize
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', setupNavigationLoading);
      } else {
        setupNavigationLoading();
      }

      // Re-setup after navigation
      document.addEventListener('astro:page-load', setupNavigationLoading);
    </script>
  </body>
</html>
