---
import { freshInstallStore } from '@/stores/backend';
import { preHealthCheck } from '@/utils/backend';
import RegistrationForm from '@/components/tenant/RegistrationForm';

const tenantId =
  Astro.locals.tenant?.id || import.meta.env.PUBLIC_TENANTID || 'default';
await preHealthCheck(tenantId);

const { needsSetup } = freshInstallStore.get();

if (!needsSetup) {
  return Astro.redirect('/storykeep');
}

const isDev = import.meta.env.DEV;
const isInitialized = !freshInstallStore.get().needsSetup;
const cssBasePath = isInitialized ? '/media/css' : '/styles';
const mainStylesUrl = isDev
  ? `${cssBasePath}/storykeep.css`
  : `${cssBasePath}/frontend.css`;
---

<!doctype html>
<html lang="en" class="h-full bg-gray-50">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Initialize TractStack</title>
    <link rel="stylesheet" href={`${cssBasePath}/custom.css`} />
    <link rel="stylesheet" href={mainStylesUrl} />
  </head>
  <body class="h-full">
    <div class="max-w-5xl p-3.5 md:p-8">
      <RegistrationForm client:load isInitMode={true} />
    </div>

    <script>
      // Ensure clean slate for fresh installation
      (function initCleanSlate() {
        try {
          // Clear admin/editor auth cookies
          document.cookie =
            'admin_auth=; path=/; expires=Thu, 01 Jan 1970 00:00:00 GMT; SameSite=Lax';
          document.cookie =
            'editor_auth=; path=/; expires=Thu, 01 Jan 1970 00:00:00 GMT; SameSite=Lax';

          // Clear all TractStack localStorage items
          const tractStackKeys = [];
          for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);
            if (key && key.startsWith('tractstack_')) {
              tractStackKeys.push(key);
            }
          }
          tractStackKeys.forEach((key) => localStorage.removeItem(key));

          // Clear session-related items
          localStorage.removeItem('tractstack_session_id');
          localStorage.removeItem('tractstack_fingerprint');
          localStorage.removeItem('tractstack_visit');
          localStorage.removeItem('tractstack_entered_tracked');

          // Clear session cookie
          document.cookie =
            'tractstack_session_id=; path=/; expires=Thu, 01 Jan 1970 00:00:00 GMT; SameSite=Lax';

          console.log('TractStack: Clean slate initialization complete');
        } catch (error) {
          console.warn('TractStack: Error during clean slate init:', error);
        }
      })();
    </script>
  </body>
</html>
