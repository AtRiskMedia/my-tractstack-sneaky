---
import { ulid } from 'ulid';
import Layout from '@/layouts/Layout.astro';
import Header from '@/components/Header.astro';
import { getFullContentMap } from '@/stores/analytics';
import { getBrandConfig } from '@/utils/api/brandConfig';
import { joinUrlPaths } from '@/utils/helpers';
import { handleFailedResponse } from '@/utils/backend';
import { components as codeHookComponents } from '@/custom/CodeHook.astro';
import StoryKeepHeader from '@/components/edit/Header';
import StoryKeepToolBar from '@/components/edit/ToolBar';
import StoryKeepToolMode from '@/components/edit/ToolMode';
import SettingsPanel from '@/components/edit/SettingsPanel';
import { Compositor } from '@/components/compositor/Compositor';
import { requireAdminOrEditor } from '@/utils/auth';
import { preHealthCheck } from '@/utils/backend';

const tenantId =
  Astro.locals.tenant?.id || import.meta.env.PUBLIC_TENANTID || 'default';

const healthCheckRedirect = await preHealthCheck(tenantId);
if (healthCheckRedirect !== undefined) {
  return healthCheckRedirect;
}

const { slug } = Astro.params;
if (!slug) return Astro.redirect('/404');

// Authentication check - redirect to login if not authenticated
const authCheck = requireAdminOrEditor(Astro);
if (authCheck) {
  return authCheck;
}

const goBackend = import.meta.env.PUBLIC_GO_BACKEND || 'http://localhost:8080';

const brandConfig = await getBrandConfig(tenantId);
if (!brandConfig.SITE_INIT) {
  return Astro.redirect('/storykeep');
}

let loadData;
let storyFragment;
let title;
let storyFragmentID;

// Handle create mode
if (slug === 'create') {
  // Create empty storyfragment in memory
  const emptyStoryFragment = {
    id: ulid(),
    nodeType: 'StoryFragment' as const,
    parentId: null,
    title: '',
    slug: '',
    paneIds: [],
    isChanged: false,
    created: new Date(),
    changed: new Date(),
  };

  loadData = {
    storyfragmentNodes: [emptyStoryFragment],
  };

  storyFragment = emptyStoryFragment;
  title = 'Create New Page - TractStack Editor';
  storyFragmentID = emptyStoryFragment.id;
} else {
  // Existing backend fetch logic
  const endpoint = `${goBackend}/api/v1/nodes/storyfragments/slug/${slug}/full-payload`;

  try {
    const response = await fetch(endpoint, {
      headers: {
        'X-Tenant-ID': tenantId,
        Cookie: Astro.request.headers.get('cookie') || '',
      },
    });

    const failedResponse = await handleFailedResponse(
      response,
      goBackend,
      tenantId,
      Astro.url.pathname
    );
    if (failedResponse) {
      return failedResponse;
    }

    loadData = await response.json();
  } catch (error) {
    console.error('Error fetching storyfragment full payload:', error);
    return Astro.redirect(
      `/maint?from=${encodeURIComponent(Astro.url.pathname)}`
    );
  }

  // Extract data from the response
  storyFragment = loadData?.storyfragmentNodes.at(0);
  title = storyFragment?.title || `Editor`;
  storyFragmentID = storyFragment?.id;
}

const canonicalURL = slug === brandConfig?.HOME_SLUG ? '/' : `/${slug}`;
const fullCanonicalURL = brandConfig?.SITE_URL
  ? canonicalURL.startsWith('/')
    ? `${brandConfig.SITE_URL.replace(/\/$/, '')}${canonicalURL}`
    : `${brandConfig.SITE_URL.replace(/\/$/, '')}/${canonicalURL}`
  : canonicalURL;

// Extract dates if available
const pubDatetime = storyFragment?.created
  ? new Date(storyFragment.created)
  : undefined;
const modDatetime = storyFragment?.changed
  ? new Date(storyFragment.changed)
  : null;

// Social image from the story fragment
const ogImage = storyFragment?.socialImagePath
  ? joinUrlPaths(brandConfig?.SITE_URL || ``, storyFragment.socialImagePath)
  : undefined;

const fullContentMap = await getFullContentMap(
  Astro.locals.tenant?.id || import.meta.env.PUBLIC_TENANTID || 'default'
);
const urlParams: Record<string, string | boolean> = {};
for (const [key, value] of Astro.url.searchParams) {
  urlParams[key] = value === '' ? true : value;
}
---

<Layout
  title={title}
  slug={slug}
  canonicalURL={canonicalURL}
  pubDatetime={pubDatetime}
  modDatetime={modDatetime}
  ogImage={ogImage}
  brandConfig={brandConfig}
  storyfragmentId={storyFragmentID}
  isStoryKeep={true}
  isEditor={true}
>
  <!-- Standard Header (scrollable) -->
  <Header
    title={title}
    slug={slug}
    brandConfig={brandConfig}
    isContext={false}
    isStoryKeep={true}
    isEditable={false}
    menu={null}
  />

  <!-- StoryKeep Editor Header (scroll-aware positioning) -->
  <section
    id="storykeepHeader"
    role="banner"
    class="z-101 bg-mywhite left-0 right-0 drop-shadow transition-all duration-200"
  >
    <StoryKeepHeader slug={slug} isContext={false} client:only="react" />
  </section>

  <div class="flex min-h-screen">
    <!-- Tool Navigation (mobile bottom, desktop side) -->
    <StoryKeepToolMode isContext={false} client:only="react" />

    <!-- Main Content Area -->
    <main
      id="mainContent"
      class="relative flex-1"
      style={{
        paddingBottom: 'var(--bottom-right-controls-bottom-offset, 16px)',
      }}
    >
      <div class="bg-myblue/20 bg-mylightgrey h-full p-1.5">
        <div
          class="h-fit min-h-screen"
          style={{
            backgroundImage:
              'repeating-linear-gradient(135deg, transparent, transparent 10px, rgba(0,0,0,0.05) 10px, rgba(0,0,0,0.05) 20px)',
          }}
        >
          <Compositor
            id={storyFragmentID}
            nodes={loadData}
            config={brandConfig}
            fullContentMap={fullContentMap}
            fullCanonicalURL={fullCanonicalURL}
            urlParams={urlParams}
            availableCodeHooks={Object.keys(codeHookComponents)}
            client:only="react"
          />
        </div>
      </div>
    </main>
  </div>

  <!-- Floating Controls (Settings Panel & HUD OR ToolBar) -->
  <aside
    id="settingsControls"
    class="z-101 pointer-events-none fixed bottom-16 right-2 flex flex-col items-end gap-2 md:bottom-2"
  >
    <div class="pointer-events-none flex-grow"></div>

    {/* Toolbar's wrapper: Does not grow or shrink */}
    <div class="pointer-events-auto flex-shrink-0">
      <StoryKeepToolBar client:only="react" />
    </div>

    {
      /* Settings Panel's wrapper: Grows, shrinks, and will be positioned by our script */
    }
    <div class="pointer-events-auto max-h-full">
      <SettingsPanel
        config={brandConfig}
        availableCodeHooks={Object.keys(codeHookComponents)}
        client:only="react"
      />
    </div>
  </aside>
</Layout>

<script>
  import { setupLayoutObservers, setupLayoutStyles } from '@/utils/layout';
  setupLayoutStyles();
  setupLayoutObservers();
</script>
