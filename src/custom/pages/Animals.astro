---
import Layout from '@/layouts/Layout.astro';
import Header from '@/components/Header.astro';
import Footer from '@/components/Footer.astro';
import { getBrandConfig } from '@/utils/api/brandConfig';
import CharacterHero from '@/custom/components/CharacterHero.astro';
import { getOrSetSessionId } from '@/lib/session';
import type { MenuNode } from '@/types/tractstack';
import type { ResourceNode } from '@/types/compositorTypes';

export interface Props {
  route: string;
  slug: string;
  variation?: string;
  resources: Record<string, ResourceNode[]>;
}

const { route, slug, resources } = Astro.props;

const tenantId =
  Astro.locals.tenant?.id || import.meta.env.PUBLIC_TENANTID || 'default';
const brandConfig = await getBrandConfig(tenantId);
const sessionId = await getOrSetSessionId(Astro, tenantId);

let menuPayload: MenuNode | null = null;
const hardcodedMenuId = '01JXXTQEAV6F1H7Z0VX6HB0379';
const goBackend = import.meta.env.PUBLIC_GO_BACKEND || 'http://localhost:8080';
try {
  const menuResponse = await fetch(
    `${goBackend}/api/v1/nodes/menus/${hardcodedMenuId}`,
    {
      headers: {
        'X-Tenant-ID': 'default',
      },
    }
  );
  if (menuResponse.ok) {
    menuPayload = await menuResponse.json();
  }
} catch (error) {
  console.error('Error fetching menu:', error);
}

const targetSlug = `${route}-${slug}`;
const activeResource = resources[route].find(
  (resource: ResourceNode) => resource.slug === targetSlug
);

const pageTitle =
  resources[route]?.find((r: ResourceNode) => r.slug === `${route}-${slug}`)
    ?.title || `${route}=${slug}`;
---

<Layout
  storyfragmentId={activeResource?.id}
  title={pageTitle}
  menu={menuPayload}
  brandConfig={brandConfig}
  sessionId={sessionId}
>
  <main id="main-content" class="w-full">
    {
      slug ? (
        <div class="pane" id={`pane-${route}-${slug}`}>
          <CharacterHero route={route} slug={slug} resources={resources} />
        </div>
      ) : null
    }
  </main>
  <script src="/client/sneaky-main.js" is:persist></script>
</Layout>
