---
import type { FullContentMapItem } from '@/types/tractstack';

export interface Props {
  options?: {
    params?: {
      options?: string;
    };
  };
  contentMap: FullContentMapItem[];
}

const { options, contentMap } = Astro.props;

// Parse component options
let parsedOptions;
try {
  parsedOptions = JSON.parse(options?.params?.options || '{}');
} catch (e) {
  console.error('Invalid options', e);
  parsedOptions = {
    topics: '',
    excludedIds: '',
    pageSize: 10,
  };
}

const excludedIdsArray = parsedOptions.excludedIds
  ? parsedOptions.excludedIds.split(',')
  : [];
const topicsArray = parsedOptions.topics ? parsedOptions.topics.split(',') : [];
const pageSize = parseInt(parsedOptions.pageSize || '10');

// Filter for valid stories to display
const validPages = contentMap.filter(
  (item: FullContentMapItem): boolean =>
    item.type === 'StoryFragment' &&
    typeof item.description === 'string' &&
    typeof item.thumbSrc === 'string' &&
    !excludedIdsArray.includes(item.id)
);

// Filter by topics if specified
let filteredStories: any[] = [];
if (topicsArray.length > 0) {
  filteredStories = validPages.filter(
    (item: FullContentMapItem) =>
      item.topics &&
      item.topics.some((topic: string) => topicsArray.includes(topic))
  );
} else {
  filteredStories = validPages;
}

// Simple sort by date - most recent first
const sortedStories = [...filteredStories].sort((a, b) => {
  const dateA = a.changed ? new Date(a.changed).getTime() : 0;
  const dateB = b.changed ? new Date(b.changed).getTime() : 0;
  return dateB - dateA;
});

// The initial display
const initialStories = sortedStories.slice(0, pageSize);
const totalPages = Math.ceil(sortedStories.length / pageSize);

const bgColor = parsedOptions.bgColor || '';
---

<div
  class="mx-auto max-w-7xl p-4 py-12"
  style={bgColor ? `background-color: ${bgColor}` : ''}
>
  {
    initialStories.length === 0 && (
      <div class="rounded-lg bg-gray-50 px-4 py-12 text-center">
        <p class="text-lg italic text-cyan-600">No stories available.</p>
      </div>
    )
  }

  <div id="mobile-content" class="block space-y-6 p-4 md:hidden">
    {
      initialStories.map((story) => (
        <a href={`/${story.slug}`} class="group block">
          <div class="flex items-start space-x-4 rounded-md p-2 group-hover:bg-slate-200/20">
            {story.thumbSrc && (
              <img
                src={story.thumbSrc}
                srcset={story.thumbSrcSet}
                alt={story.title}
                style="aspect-ratio: 1200 / 630;"
                class="w-36 flex-shrink-0 rounded-md md:w-48 xl:w-72"
              />
            )}
            <div class="flex-1">
              <h3 class="text-lg font-bold text-black transition-colors group-hover:text-gray-900">
                {story.title}
              </h3>
              {story.description && (
                <p class="line-clamp-2 text-sm text-gray-800">
                  {story.description}
                </p>
              )}
              {story.topics && story.topics.length > 0 && (
                <div class="mt-4 flex flex-wrap gap-1">
                  {story.topics.slice(0, 3).map((topic: string) => (
                    <span class="inline-flex items-center rounded-full bg-gray-100 px-2 py-0.5 text-xs font-bold text-gray-800">
                      {topic}
                    </span>
                  ))}
                </div>
              )}
            </div>
          </div>
        </a>
      ))
    }
  </div>

  <div id="desktop-content" class="hidden p-4 md:flex md:space-x-6">
    <div class="space-y-6 md:w-1/2">
      {
        initialStories
          .slice(0, Math.ceil(initialStories.length / 2))
          .map((story) => (
            <a href={`/${story.slug}`} class="group block">
              <div class="flex items-start space-x-4 rounded-md p-2 group-hover:bg-slate-200/20">
                {story.thumbSrc && (
                  <img
                    src={story.thumbSrc}
                    srcset={story.thumbSrcSet}
                    alt={story.title}
                    style="aspect-ratio: 1200 / 630;"
                    class="w-36 flex-shrink-0 rounded-md md:w-48 xl:w-72"
                  />
                )}
                <div class="flex-1">
                  <h3 class="text-lg font-bold text-black transition-colors group-hover:text-gray-900">
                    {story.title}
                  </h3>
                  {story.description && (
                    <p class="line-clamp-2 text-sm text-gray-800">
                      {story.description}
                    </p>
                  )}
                  {story.topics && story.topics.length > 0 && (
                    <div class="mt-1 flex flex-wrap gap-1">
                      {story.topics.slice(0, 3).map((topic: string) => (
                        <span class="inline-flex items-center rounded-full bg-gray-100 px-2 py-0.5 text-xs font-bold text-gray-800">
                          {topic}
                        </span>
                      ))}
                    </div>
                  )}
                </div>
              </div>
            </a>
          ))
      }
    </div>
    <div class="space-y-6 md:w-1/2">
      {
        initialStories
          .slice(Math.ceil(initialStories.length / 2))
          .map((story) => (
            <a href={`/${story.slug}`} class="group block">
              <div class="flex items-start space-x-4 rounded-md p-2 group-hover:bg-slate-200/20">
                {story.thumbSrc && (
                  <img
                    src={story.thumbSrc}
                    srcset={story.thumbSrcSet}
                    alt={story.title}
                    style="aspect-ratio: 1200 / 630;"
                    class="w-36 flex-shrink-0 rounded-md md:w-48 xl:w-72"
                  />
                )}
                <div class="flex-1">
                  <h3 class="text-lg font-bold text-black transition-colors group-hover:text-gray-900">
                    {story.title}
                  </h3>
                  {story.description && (
                    <p class="line-clamp-2 text-sm text-gray-800">
                      {story.description}
                    </p>
                  )}
                  {story.topics && story.topics.length > 0 && (
                    <div class="mt-1 flex flex-wrap gap-1">
                      {story.topics.slice(0, 3).map((topic: string) => (
                        <span class="inline-flex items-center rounded-full bg-gray-100 px-2 py-0.5 text-xs font-bold text-gray-800">
                          {topic}
                        </span>
                      ))}
                    </div>
                  )}
                </div>
              </div>
            </a>
          ))
      }
    </div>
  </div>

  {
    filteredStories.length > pageSize && (
      <div class="mt-8 flex items-center justify-center">
        <div id="page-info" class="mr-4 text-sm text-gray-700">
          Page <span id="current-page-num">1</span> of{' '}
          <span id="total-pages-num">{totalPages}</span>
        </div>
        <nav class="inline-flex rounded-md shadow-sm" aria-label="Pagination">
          <button
            id="prev-page"
            class="rounded-l-md border border-gray-300 bg-white px-4 py-2 text-sm font-bold text-gray-800 hover:bg-gray-100 disabled:cursor-not-allowed disabled:opacity-50"
            disabled
          >
            Previous
          </button>
          <button
            id="next-page"
            class="rounded-r-md border border-cyan-600 bg-cyan-600 px-4 py-2 text-sm font-bold text-white hover:bg-cyan-700 disabled:cursor-not-allowed disabled:opacity-50"
            disabled={totalPages <= 1}
          >
            Next
          </button>
        </nav>
      </div>
    )
  }
</div>

<script
  is:inline
  define:vars={{
    sortedStories,
    pageSize,
  }}
>
  // === CLIENT-SIDE STATE ===
  let currentPage = 1;

  // === DOM ELEMENTS ===
  const mobileContainer = document.getElementById('mobile-content');
  const desktopContainer = document.getElementById('desktop-content');
  const prevPageBtn = document.getElementById('prev-page');
  const nextPageBtn = document.getElementById('next-page');

  // === DOM UPDATING ===
  function createStoryItem(story) {
    const imageHtml = story.thumbSrc
      ? `<img src="${story.thumbSrc}" srcset="${story.thumbSrcSet || ''}" alt="${story.title}" style="aspect-ratio: 1200 / 630;" class="w-36 flex-shrink-0 rounded-md md:w-48 xl:w-72">`
      : '';
    const descriptionHtml = story.description
      ? `<p class="text-sm text-gray-800 line-clamp-2">${story.description}</p>`
      : '';
    const topicsHtml =
      story.topics && story.topics.length > 0
        ? `<div class="mt-4 flex flex-wrap gap-1">${story.topics
            .slice(0, 3)
            .map(
              (topic) =>
                `<span class="inline-flex items-center rounded-full bg-gray-100 px-2 py-0.5 text-xs font-bold text-gray-800">${topic}</span>`
            )
            .join('')}</div>`
        : '';

    return `
      <a href="/${story.slug}" class="group block">
        <div class="flex items-start space-x-4 rounded-md p-2 group-hover:bg-slate-200/20">
          ${imageHtml}
          <div class="flex-1">
            <h3 class="text-lg font-bold text-black transition-colors group-hover:text-gray-900">${story.title}</h3>
            ${descriptionHtml}
            ${topicsHtml}
          </div>
        </div>
      </a>
    `;
  }

  function updateDisplayedContent() {
    const totalPages = Math.ceil(sortedStories.length / pageSize);
    const startIdx = (currentPage - 1) * pageSize;
    const endIdx = startIdx + pageSize;
    const pageData = sortedStories.slice(startIdx, endIdx);

    if (mobileContainer)
      mobileContainer.innerHTML = pageData.map(createStoryItem).join('');

    if (desktopContainer) {
      const midpoint = Math.ceil(pageData.length / 2);
      const leftCol = pageData.slice(0, midpoint);
      const rightCol = pageData.slice(midpoint);
      desktopContainer.innerHTML = `
          <div class="space-y-6 md:w-1/2">${leftCol.map(createStoryItem).join('')}</div>
          <div class="space-y-6 md:w-1/2">${rightCol.map(createStoryItem).join('')}</div>
        `;
    }

    // Update pagination state
    if (prevPageBtn) prevPageBtn.disabled = currentPage === 1;
    if (nextPageBtn) nextPageBtn.disabled = currentPage >= totalPages;
    const pageInfoNum = document.getElementById('current-page-num');
    const totalPagesNum = document.getElementById('total-pages-num');
    if (pageInfoNum) pageInfoNum.textContent = currentPage;
    if (totalPagesNum) totalPagesNum.textContent = totalPages;
  }

  // === EVENT LISTENERS ===
  if (prevPageBtn)
    prevPageBtn.addEventListener('click', () => {
      if (currentPage > 1) {
        currentPage--;
        updateDisplayedContent();
      }
    });
  if (nextPageBtn)
    nextPageBtn.addEventListener('click', () => {
      const totalPages = Math.ceil(sortedStories.length / pageSize);
      if (currentPage < totalPages) {
        currentPage++;
        updateDisplayedContent();
      }
    });
</script>
